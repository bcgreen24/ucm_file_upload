<?php

function ucm_file_upload_help($path, $arg){
    if($path == 'admin/help#ucm_file_upload'){
        return t('UCM file upload module');
    }
}

function ucm_file_upload_menu(){
    $items = array();
    $items['fileupload'] = array(
        'title'=> 'File Upload',
        'description' => 'Upload files',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('ucm_file_upload_form'),
        'access arguments' => array('upload files'),
        'type' => MENU_CALLBACK,
    );
    drupal_set_title('File Upload') ;
    return $items;
    
}

function ucm_file_upload_form($form, &$form_state){
    $form['file1'] = array(
       '#name' => 'files[]',
       '#type' => 'file',
       '#title' => t('Choose the file to upload'),
       '#size' => 22,
       '#description' => t('Upload a file to the public directory'),
    );
    
    $form['file2'] = array(
       '#name' => 'files[]',
       '#type' => 'file',
       '#title' => t('Choose the file to upload'),
       '#size' => 22,
       '#description' => t('Upload a file to the public directory'),
    );
    
    $form['file3'] = array(
       '#name' => 'files[]',
       '#type' => 'file',
       '#title' => t('Choose the file to upload'),
       '#size' => 22,
       '#description' => t('Upload a file to the public directory'),
    );
    
    $form['submit'] = array(
       '#type' => 'submit',
        '#value' => t('Upload files'),
        '#submit' => array('ucm_file_upload_submit'),
        );
        drupal_set_title('File Upload') ;
    return $form;
}

function ucm_file_upload_submit($form, &$form_state){
    $message = "";
    
    foreach($form_state['complete form'] as $file){
        if($file['#type'] == 'file'){
//            $file = file_save_upload($file['#parents'][0]);
//            if($file){
//                if($file = file_move($file, 'public://')){
//                   $form_state['values']['file'] = $file;
//                   $message .= "File uploaded! Use this URL: /files/" . $file->filename . "<br/>";                   
//                }
//            }else{
//              $message .= "Error uploading file [" . $file['#parents'][0] . "]; please try again later.<br/>" ; 
//            }
            $message .= $file['#parents'][0];
        }
    }
    drupal_set_message($message);
}

function ucm_file_upload_permission(){
    
    return array('upload files' => array(
     'title' => t('Upload files'),
     'description' => t('Allows users to upload arbitrary files to the public files directory.'),   
    )
    );
}

/**
 * Implements hook_user_default_permissions().
 */
function ucm_file_upload_user_default_permissions() {
  $permissions = array();

  // Exported permission: upload files.
  $permissions['upload files'] = array(
    'name' => 'upload files',
    'roles' => array(
      0 => 'administrator',
      1 => 'site manager',
    ),
    'module' => 'ucm_file_upload',
  );

  return $permissions;
}
